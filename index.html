<!DOCTYPE html>
<html>
<head>
  <title>Mortgage Rate Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>  
</head>
<body>
  <h1>Mortgage Rate Tracker - Wells Fargo</h1>
  <a href="https://www.wellsfargo.com/mortgage/rates/">Wells Fargo Mortgage Rates Now</a>
  <div>
    <label for="Product-select">Select Product:</label>
    <select id="Product-select"></select>
  </div>
  <div>
    <label for="Term-select">Select Term:</label>
    <select id="Term-select"></select>
  </div>
  <canvas id="chart"></canvas>

  <script>
    // Load data from CSV
    var currentChart = null;

    fetch('data/mortgage_rates.csv')
      .then(response => response.text())
      .then(csvData => {
        const data = Papa.parse(csvData, { header: true }).data;

        // Extract unique values for Product and Term
        const Products = [...new Set(data.map(row => row.Product))];
        const Terms = [...new Set(data.map(row => row.Term))];

        // Populate dropdown menus
        const ProductSelect = document.getElementById('Product-select');
        const TermSelect = document.getElementById('Term-select');

        Products.forEach(Product => {
          const option = document.createElement('option');
          option.value = Product;
          option.textContent = Product;
          ProductSelect.appendChild(option);
        });

        Terms.forEach(Term => {
          const option = document.createElement('option');
          option.value = Term;
          option.textContent = Term;
          TermSelect.appendChild(option);
        });

        // Update chart on dropdown selection change
        ProductSelect.addEventListener('change', updateChart);
        TermSelect.addEventListener('change', updateChart);

        // Initial chart rendering
        updateChart();

        function updateChart() {
          const selectedProduct = ProductSelect.value;
          const selectedTerm = TermSelect.value;

          console.log(selectedProduct, selectedTerm);
          // Filter data based on selected Product and Term
          const filteredData = data.filter(row => row.Product === selectedProduct && row.Term === selectedTerm);

          // Extract date, rate, and apr values for chart
          const dates = filteredData.map(row => row.date);
          const rates = filteredData.map(row => parseFloat(row.Rate));
          const aprs = filteredData.map(row => parseFloat(row.APR));

          // Create chart
          const ctx = document.getElementById('chart').getContext('2d');
          console.log(currentChart);

          if (currentChart) {
            console.log('destroying chart');
            currentChart.destroy();
          }
          currentChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: dates,
              datasets: [
                {
                  label: 'Rate',
                  data: rates,
                  borderColor: 'blue',
                  fill: false
                },
                {
                  label: 'APR',
                  data: aprs,
                  borderColor: 'red',
                  fill: false
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              scales: {
                x: {
                  type: 'time',                  
                  display: true,
                  title: {
                    display: true,
                    text: 'Date'
                  }
                },
                y: {
                  display: true,
                  title: {
                    display: true,
                    text: 'Rate & APR'
                  }
                }
              }
            }
          });
        }
      });
  </script>
</body>
</html>